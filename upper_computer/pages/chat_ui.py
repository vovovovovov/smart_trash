import streamlit as st
from openai import OpenAI

# é¡µé¢é…ç½®
st.set_page_config(
    page_title="åƒåœ¾åˆ†ç±»æµ‹è¯•åŠ©æ‰‹",
    page_icon="ğŸ—‘ï¸",
    layout="centered"
)

# åˆå§‹åŒ–OpenAIå®¢æˆ·ç«¯
def get_client():
    return OpenAI(
        api_key='TODO',  # æ¨èä½¿ç”¨st.secretsç®¡ç†å¯†é’¥
        base_url="https://dashscope.aliyuncs.com/compatible-mode/v1",
    )

# é¢„è®¾å›ç­”è§„åˆ™
PRESET_RULES = {
    # æœ‰å®³åƒåœ¾
    "ç”µæ± ": "ğŸ”‹ ç”µæ± å±äºæœ‰å®³åƒåœ¾ï¼è¯·æ”¾å…¥çº¢è‰²åƒåœ¾æ¡¶ï¼Œé¿å…æ±¡æŸ“ç¯å¢ƒ",
    "è§å…‰ç¯ç®¡": "ğŸ’¡ è§å…‰ç¯ç®¡å«æœ‰æ±ï¼Œå±äºæœ‰å®³åƒåœ¾ï¼",
    "è¯å“": "ğŸ’Š è¿‡æœŸè¯å“å±äºæœ‰å®³åƒåœ¾ï¼è¯·å‹¿éšæ„ä¸¢å¼ƒ",
    # å¯å›æ”¶ç‰©
    "å¡‘æ–™ç“¶": "ğŸ§´ å¡‘æ–™ç“¶å±äºå¯å›æ”¶ç‰©ï¼è¯·æ¸…ç©ºå¹¶å‹æ‰åæ”¾å…¥è“è‰²åƒåœ¾æ¡¶",
    "çº¸å¼ ": "ğŸ“„ åºŸçº¸å±äºå¯å›æ”¶ç‰©ï¼è¯·é¿å…æ±¡æŸ“åæ”¾å…¥è“è‰²åƒåœ¾æ¡¶",
    "ç»ç’ƒ": "ğŸ”® ç»ç’ƒåˆ¶å“å±äºå¯å›æ”¶ç‰©ï¼å°å¿ƒå¤„ç†é¿å…å‰²ä¼¤",
    "é‡‘å±": "ğŸª™ é‡‘å±åˆ¶å“å±äºå¯å›æ”¶ç‰©ï¼å¯å†å¾ªç¯åˆ©ç”¨",
    # å¨ä½™åƒåœ¾
    "æœçš®": "ğŸŒ æœçš®å±äºå¨ä½™åƒåœ¾ï¼è¯·æ”¾å…¥ç»¿è‰²åƒåœ¾æ¡¶",
    "å‰©é¥­": "ğŸš å‰©é¥­å‰©èœå±äºå¨ä½™åƒåœ¾ï¼å¯ç”¨äºå †è‚¥",
    "èŒ¶å¶": "ğŸµ èŒ¶å¶æ¸£å±äºå¨ä½™åƒåœ¾ï¼æ˜¯å¤©ç„¶è‚¥æ–™",
    # å…¶ä»–åƒåœ¾
    "çº¸å·¾": "ğŸ§» çº¸å·¾å±äºå…¶ä»–åƒåœ¾ï¼è¯·æ”¾å…¥ç°è‰²åƒåœ¾æ¡¶",
    "å°¿ä¸æ¹¿": "ğŸ‘¶ å°¿ä¸æ¹¿å±äºå…¶ä»–åƒåœ¾ï¼å«ç”Ÿå¤„ç†åä¸¢å¼ƒ",
    "é™¶ç“·": "ğŸº é™¶ç“·ç¢ç‰‡å±äºå…¶ä»–åƒåœ¾ï¼è¯·åŒ…è£¹åä¸¢å¼ƒ",
    # ç‰¹æ®Šå¤„ç†é¡¹
    "å¥¶èŒ¶æ¯": "ğŸ§‹ å¥¶èŒ¶æ¯ç‰¹æ®Šå¤„ç†ï¼š\n1. å€’æ‰æ¶²ä½“â†’å¨ä½™åƒåœ¾\n2. çç ç­‰é…æ–™â†’å¨ä½™åƒåœ¾\n3. æ¯èº«ã€æ¯ç›–â†’å…¶ä»–åƒåœ¾\n4. å¸ç®¡â†’å…¶ä»–åƒåœ¾",
    "ç”µæ± åŒ…è£…": "ğŸ“¦ ç”µæ± åŒ…è£…å¤„ç†ï¼š\n- å¡‘æ–™å¤–åŒ…è£…â†’å¯å›æ”¶\n- é˜²ä¼ªæ ‡ç­¾â†’å…¶ä»–åƒåœ¾\n- ç”µæ± æœ¬èº«â†’æœ‰å®³åƒåœ¾",
}

# AIæ¨¡å‹äº¤äº’å‡½æ•°
def ai_classify(prompt):
    """ä½¿ç”¨å¤§æ¨¡å‹å¤„ç†æœªè¦†ç›–çš„åƒåœ¾åˆ†ç±»æŸ¥è¯¢"""
    client = get_client()
    
    # ç²¾å¿ƒè®¾è®¡çš„ç³»ç»Ÿæç¤ºè¯
    system_prompt = """
    ä½ æ˜¯ä¸€åä¸“ä¸šçš„åƒåœ¾åˆ†ç±»åŠ©æ‰‹AIå­¦æµ·è¡Œï¼Œè¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹è§„åˆ™å›ç­”ï¼š
    1. åªèƒ½å›ç­”ä¸åƒåœ¾åˆ†ç±»ç›¸å…³çš„é—®é¢˜
    2. å›ç­”éœ€åŒ…å«åˆ†ç±»ç»“æœå’Œç®€è¦è§£é‡Š
    3. ä½¿ç”¨åƒåœ¾åˆ†ç±»ä¸“ä¸šæœ¯è¯­ï¼šå¯å›æ”¶ç‰©ã€æœ‰å®³åƒåœ¾ã€å¨ä½™åƒåœ¾ã€å…¶ä»–åƒåœ¾
    4. å›ç­”ç®€æ´æ˜äº†ï¼Œä¸è¶…è¿‡50å­—
    5. æ ¼å¼èŒƒä¾‹ï¼šã€åˆ†ç±»ç»“æœã€‘å¨ä½™åƒåœ¾ â†’ æœçš®å¯è‡ªç„¶é™è§£
    """
    
    response = client.chat.completions.create(
        model="qwen-plus",
        messages=[
            {'role': 'system', 'content': system_prompt},
            {'role': 'user', 'content': prompt}
        ],
        temperature=0.1  # é™ä½éšæœºæ€§
    )
    return response.choices[0].message.content

# å¤„ç†ç”¨æˆ·æŸ¥è¯¢çš„ç»Ÿä¸€å‡½æ•°
def classify_waste(prompt):
    """å¤„ç†åƒåœ¾åˆ†ç±»æŸ¥è¯¢ï¼šä¼˜å…ˆä½¿ç”¨é¢„è®¾è§„åˆ™ï¼Œæœªè¦†ç›–æ—¶è°ƒç”¨AI"""
    # æ£€æŸ¥é¢„è®¾è§„åˆ™
    for item, response in PRESET_RULES.items():
        if item in prompt:
            return response
    
    # è°ƒç”¨AIå¤„ç†æœªè¦†ç›–çš„æŸ¥è¯¢
    return ai_classify(prompt)

# åˆå§‹åŒ–å¯¹è¯
if "messages" not in st.session_state:
    st.session_state.messages = [
        {"role": "assistant", "content": "ğŸ” åƒåœ¾åˆ†ç±»æµ‹è¯•åŠ©æ‰‹å·²å¯åŠ¨ï¼è¯·æé—®ï¼š\nä¾‹ï¼šç”µæ± æ˜¯ä»€ä¹ˆåƒåœ¾ï¼Ÿå¥¶èŒ¶æ¯å¦‚ä½•å¤„ç†ï¼Ÿ"}
    ]

# ä¸»ç•Œé¢
st.title("â™»ï¸ åƒåœ¾åˆ†ç±»æµ‹è¯•åŠ©æ‰‹")
st.caption("AIå­¦æµ·è¡Œ | ä¸“ä¸šåƒåœ¾åˆ†ç±»æŒ‡å¯¼")

# æ˜¾ç¤ºå†å²å¯¹è¯
for msg in st.session_state.messages:
    with st.chat_message(msg["role"]):
        st.markdown(msg["content"])

# ç”¨æˆ·è¾“å…¥å¤„ç†
if prompt := st.chat_input("è¾“å…¥åƒåœ¾åç§°æˆ–å¤„ç†é—®é¢˜..."):
    # æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    st.session_state.messages.append({"role": "user", "content": prompt})
    
    try:
        # å¤„ç†ç”¨æˆ·æŸ¥è¯¢
        response = classify_waste(prompt)
        
        # æ·»åŠ AIå›å¤
        st.session_state.messages.append({"role": "assistant", "content": response})
    except Exception as e:
        # APIé”™è¯¯å¤„ç†
        error_msg = f"âš ï¸ æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•\nï¼ˆé”™è¯¯ä»£ç ï¼š{str(e)}ï¼‰"
        st.session_state.messages.append({"role": "assistant", "content": error_msg})
    
    # åˆ·æ–°ç•Œé¢
    st.rerun()

# ä¾§è¾¹æ è¯´æ˜
st.sidebar.title("ğŸ—‚ï¸ åˆ†ç±»è¯´æ˜")
st.sidebar.subheader("ğŸŸ¥ æœ‰å®³åƒåœ¾")
st.sidebar.caption("å«åŒ–å­¦å“/é‡é‡‘å±ç‰©å“ å¦‚ç”µæ± ã€è¯å“")
st.sidebar.divider()

st.sidebar.subheader("ğŸŸ¦ å¯å›æ”¶ç‰©")
st.sidebar.caption("æ¸…æ´å¯å†åˆ©ç”¨ç‰©å“ å¦‚å¡‘æ–™ã€çº¸å¼ ")
st.sidebar.divider()

st.sidebar.subheader("ğŸŸ© å¨ä½™åƒåœ¾")
st.sidebar.caption("æ˜“è…çƒ‚é£Ÿå“ç±»åºŸç‰© å¦‚æœçš®ã€å‰©èœ")
st.sidebar.divider()

st.sidebar.subheader("â¬œ å…¶ä»–åƒåœ¾")
st.sidebar.caption("é™¤å‰ä¸‰ç±»å¤–çš„åƒåœ¾ å¦‚çº¸å·¾ã€ä¸€æ¬¡æ€§ç”¨å“")
st.sidebar.divider()

st.sidebar.caption("åŠŸèƒ½è¯´æ˜:\n- ä¼˜å…ˆåŒ¹é…é¢„è®¾è§„åˆ™\n- æœªè¦†ç›–æ—¶è°ƒç”¨AIåˆ†æ\n- å¤„ç†å¤æ‚åƒåœ¾åˆ†ç±»é—®é¢˜")